<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Información de Salud - SSOMA</title>
</head>
<body>
<h1>Información de Salud</h1>

<nav>
    <a href="index.html">Inicio</a> |
    <a href="personas.html">Personas</a> |
    <a href="certificaciones.html">Certificaciones</a> |
    <a href="salud.html">Salud</a> |
    <a href="scores.html">Scores</a>
</nav>

<!-- Formulario -->
<h2>Crear/Editar Información de Salud</h2>
<form id="saludForm">
    <input type="hidden" id="saludId">

    <label>Persona ID:</label>
    <input type="text" id="personaId" required placeholder="UUID de la persona"><br><br>

    <label>Grupo Sanguíneo:</label>
    <select id="grupoSanguineo">
        <option value="">Seleccione grupo</option>
        <option value="A+">A+</option>
        <option value="A-">A-</option>
        <option value="B+">B+</option>
        <option value="B-">B-</option>
        <option value="AB+">AB+</option>
        <option value="AB-">AB-</option>
        <option value="O+">O+</option>
        <option value="O-">O-</option>
    </select><br><br>

    <label>Alergias:</label>
    <textarea id="alergias" rows="3" placeholder="Describa las alergias conocidas..."></textarea><br><br>

    <label>Historial Médico:</label>
    <textarea id="historialMedico" rows="5" placeholder="Historial médico relevante..."></textarea><br><br>

    <button type="submit">Guardar</button>
    <button type="button" onclick="limpiarForm()">Limpiar</button>
    <button type="button" onclick="buscarSalud()">Buscar Info Existente</button>
</form>

<!-- Lista/Vista de información actual -->
<h2>Información Actual</h2>
<div id="infoActual">
    <p>No hay información de salud cargada.</p>
</div>

<script>
    const API_URL = 'http://localhost:8080/api/v1';
    let editandoSalud = false;
    let personaSeleccionada = null;

    document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const personaIdParam = urlParams.get('personaId');
        if (personaIdParam) {
            document.getElementById('personaId').value = personaIdParam;
            personaSeleccionada = personaIdParam;
            buscarSalud();
        }

        document.getElementById('saludForm').onsubmit = function(e) {
            e.preventDefault();
            guardarSalud();
        };
    });

    async function buscarSalud() {
        const personaId = document.getElementById('personaId').value.trim();

        if (!personaId) {
            alert('Por favor ingrese un Persona ID');
            return;
        }

        try {
            const response = await fetch(`${API_URL}/salud-personas/persona/${personaId}`);

            if (response.ok) {
                const data = await response.json();

                if (data.success && data.data) {
                    const salud = data.data;
                    document.getElementById('saludId').value = salud.saludId;
                    document.getElementById('grupoSanguineo').value = salud.grupoSanguineo || '';
                    document.getElementById('alergias').value = salud.alergias || '';
                    document.getElementById('historialMedico').value = salud.historialMedico || '';

                    mostrarInfoActual(salud);
                    editandoSalud = true;
                    alert('Información de salud encontrada y cargada');
                } else {
                    document.getElementById('infoActual').innerHTML = '<p>No existe información de salud para esta persona.</p>';
                    editandoSalud = false;
                }
            } else {
                document.getElementById('infoActual').innerHTML = '<p>No existe información de salud para esta persona.</p>';
                editandoSalud = false;
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error de conexión: ' + error.message);
        }
    }

    function mostrarInfoActual(salud) {
        document.getElementById('infoActual').innerHTML = `
            <div style="border: 1px solid #ddd; padding: 15px; background: #f9f9f9;">
                <h3>Información de Salud Actual</h3>
                <p><strong>Grupo Sanguíneo:</strong> ${salud.grupoSanguineo || 'No especificado'}</p>
                <p><strong>Alergias:</strong> ${salud.alergias || 'Ninguna registrada'}</p>
                <p><strong>Historial Médico:</strong> ${salud.historialMedico || 'Sin historial registrado'}</p>
            </div>
        `;
    }

    async function guardarSalud() {
        const personaId = document.getElementById('personaId').value.trim();

        if (!personaId) {
            alert('El Persona ID es obligatorio');
            return;
        }

        const salud = {
            personaId: personaId,
            grupoSanguineo: document.getElementById('grupoSanguineo').value || null,
            alergias: document.getElementById('alergias').value.trim() || null,
            historialMedico: document.getElementById('historialMedico').value.trim() || null
        };

        try {
            let response;
            if (editandoSalud) {
                const id = document.getElementById('saludId').value;
                response = await fetch(`${API_URL}/salud-personas/${id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(salud)
                });
            } else {
                response = await fetch(`${API_URL}/salud-personas`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(salud)
                });
            }

            const data = await response.json();

            if (data.success) {
                alert(editandoSalud ? 'Información actualizada exitosamente' : 'Información creada exitosamente');
                if (!editandoSalud) {
                    editandoSalud = true;
                    document.getElementById('saludId').value = data.data.saludId;
                }
                mostrarInfoActual(data.data);
            } else {
                alert('Error: ' + data.message);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error guardando información de salud');
        }
    }

    function limpiarForm() {
        document.getElementById('saludForm').reset();
        document.getElementById('saludId').value = '';
        document.getElementById('infoActual').innerHTML = '<p>No hay información de salud cargada.</p>';
        if (personaSeleccionada) {
            document.getElementById('personaId').value = personaSeleccionada;
        }
        editandoSalud = false;
    }
</script>
</body>
</html>