<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personas - SSOMA</title>
</head>
<body>
<h1>Gestión de Personas</h1>

<nav>
    <a href="index.html">Inicio</a> |
    <a href="personas.html">Personas</a> |
    <a href="certificaciones.html">Certificaciones</a> |
    <a href="salud.html">Salud</a> |
    <a href="scores.html">Scores</a>
</nav>

<!-- Formulario -->
<h2>Crear/Editar Persona</h2>
<form id="personaForm">
    <input type="hidden" id="personaId">

    <label>Empresa ID:</label>
    <input type="text" id="empresaId" required placeholder="UUID de la empresa"><br><br>

    <label>Tipo de Persona:</label>
    <select id="tipoPersona" required>
        <option value="">Seleccione tipo</option>
        <option value="Empleado">Empleado</option>
        <option value="Contratista">Contratista</option>
    </select><br><br>

    <label>Nombre Completo:</label>
    <input type="text" id="nombreCompleto" required><br><br>

    <label>DNI:</label>
    <input type="text" id="dni" required pattern="[0-9]{8}" placeholder="12345678"><br><br>

    <label>Fecha de Nacimiento:</label>
    <input type="date" id="fechaNacimiento"><br><br>

    <label>Género:</label>
    <select id="genero">
        <option value="">Seleccione género</option>
        <option value="Masculino">Masculino</option>
        <option value="Femenino">Femenino</option>
        <option value="Otro">Otro</option>
    </select><br><br>

    <label>Teléfono:</label>
    <input type="tel" id="telefono" placeholder="987654321"><br><br>

    <label>Correo:</label>
    <input type="email" id="correo"><br><br>

    <button type="submit">Guardar</button>
    <button type="button" onclick="limpiarForm()">Limpiar</button>
</form>

<!-- Filtros -->
<h2>Filtros</h2>
<label>Filtrar por tipo:</label>
<select id="filtroTipo" onchange="aplicarFiltros()">
    <option value="">Todos</option>
    <option value="Empleado">Empleado</option>
    <option value="Contratista">Contratista</option>
</select>

<label>Buscar por nombre:</label>
<input type="text" id="searchNombre" placeholder="Buscar persona..." onkeyup="buscarPersonas()">

<button onclick="cargarPersonas()">Ver Todos</button>

<!-- Lista -->
<h2>Lista de Personas</h2>
<button onclick="cargarPersonas()">Actualizar Lista</button>

<table border="1">
    <thead>
    <tr>
        <th>DNI</th>
        <th>Nombre Completo</th>
        <th>Tipo</th>
        <th>Teléfono</th>
        <th>Correo</th>
        <th>Acciones</th>
    </tr>
    </thead>
    <tbody id="personasTable">
    <tr><td colspan="6">Cargando...</td></tr>
    </tbody>
</table>

<script>
    const API_URL = 'http://localhost:8080/api/v1';
    let editando = false;

    document.addEventListener('DOMContentLoaded', function() {
        cargarPersonas();

        document.getElementById('personaForm').onsubmit = function(e) {
            e.preventDefault();
            guardarPersona();
        };

        // Establecer fecha por defecto: hace 25 años
        const fechaDefecto = new Date();
        fechaDefecto.setFullYear(fechaDefecto.getFullYear() - 25);
        document.getElementById('fechaNacimiento').value = fechaDefecto.toISOString().split('T')[0];
    });

    async function cargarPersonas() {
        try {
            const response = await fetch(`${API_URL}/personas?page=0&size=50`);
            const data = await response.json();

            const tbody = document.getElementById('personasTable');

            if (data.success && data.data.content.length > 0) {
                tbody.innerHTML = data.data.content.map(persona => `
                    <tr>
                        <td>${persona.dni}</td>
                        <td>${persona.nombreCompleto}</td>
                        <td>${persona.tipoPersona}</td>
                        <td>${persona.telefono || '-'}</td>
                        <td>${persona.correo || '-'}</td>
                        <td>
                            <button onclick="editarPersona('${persona.personaId}')">Editar</button>
                            <button onclick="eliminarPersona('${persona.personaId}')">Eliminar</button>
                            <button onclick="verCertificaciones('${persona.personaId}')">Certificaciones</button>
                            <button onclick="verSalud('${persona.personaId}')">Salud</button>
                            <button onclick="verScores('${persona.personaId}')">Scores</button>
                        </td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="6">No hay personas</td></tr>';
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error cargando personas');
        }
    }

    async function guardarPersona() {
        const empresaId = document.getElementById('empresaId').value.trim();
        const dni = document.getElementById('dni').value.trim();
        const nombreCompleto = document.getElementById('nombreCompleto').value.trim();

        if (!empresaId || !dni || !nombreCompleto) {
            alert('Por favor complete los campos obligatorios');
            return;
        }

        // Validar formato de UUID básico
        const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
        if (!uuidRegex.test(empresaId)) {
            alert('El formato del ID de empresa no es válido');
            return;
        }

        // Validar DNI
        if (!/^\d{8}$/.test(dni)) {
            alert('El DNI debe tener exactamente 8 dígitos');
            return;
        }

        const persona = {
            empresaId: empresaId,
            tipoPersona: document.getElementById('tipoPersona').value,
            nombreCompleto: nombreCompleto,
            dni: dni,
            fechaNacimiento: document.getElementById('fechaNacimiento').value || null,
            genero: document.getElementById('genero').value || null,
            telefono: document.getElementById('telefono').value.trim() || null,
            correo: document.getElementById('correo').value.trim() || null
        };

        try {
            let response;
            if (editando) {
                const id = document.getElementById('personaId').value;
                response = await fetch(`${API_URL}/personas/${id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(persona)
                });
            } else {
                response = await fetch(`${API_URL}/personas`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(persona)
                });
            }

            const data = await response.json();

            if (data.success) {
                alert(editando ? 'Persona actualizada exitosamente' : 'Persona creada exitosamente');
                limpiarForm();
                cargarPersonas();
            } else {
                alert('Error: ' + data.message);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error guardando persona');
        }
    }

    async function editarPersona(id) {
        try {
            const response = await fetch(`${API_URL}/personas/${id}`);
            const data = await response.json();

            if (data.success) {
                const persona = data.data;
                document.getElementById('personaId').value = persona.personaId;
                document.getElementById('empresaId').value = persona.empresaId;
                document.getElementById('tipoPersona').value = persona.tipoPersona;
                document.getElementById('nombreCompleto').value = persona.nombreCompleto;
                document.getElementById('dni').value = persona.dni;
                document.getElementById('fechaNacimiento').value = persona.fechaNacimiento || '';
                document.getElementById('genero').value = persona.genero || '';
                document.getElementById('telefono').value = persona.telefono || '';
                document.getElementById('correo').value = persona.correo || '';

                editando = true;
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error cargando persona');
        }
    }

    async function eliminarPersona(id) {
        if (confirm('¿Eliminar persona? Esta acción también eliminará toda su información relacionada (salud, scores, certificaciones).')) {
            try {
                const response = await fetch(`${API_URL}/personas/${id}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    alert('Persona eliminada exitosamente');
                    cargarPersonas();
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error eliminando persona');
            }
        }
    }

    // ENLACES A PÁGINAS ESPECÍFICAS
    function verCertificaciones(personaId) {
        window.location.href = `certificaciones.html?personaId=${personaId}`;
    }

    function verSalud(personaId) {
        window.location.href = `salud.html?personaId=${personaId}`;
    }

    function verScores(personaId) {
        window.location.href = `scores.html?personaId=${personaId}`;
    }

    function limpiarForm() {
        document.getElementById('personaForm').reset();
        document.getElementById('personaId').value = '';

        // Establecer fecha por defecto: hace 25 años
        const fechaDefecto = new Date();
        fechaDefecto.setFullYear(fechaDefecto.getFullYear() - 25);
        document.getElementById('fechaNacimiento').value = fechaDefecto.toISOString().split('T')[0];

        editando = false;
    }

    // FUNCIONES DE FILTROS
    async function aplicarFiltros() {
        const tipo = document.getElementById('filtroTipo').value;
        if (tipo) {
            try {
                const response = await fetch(`${API_URL}/personas/tipo/${tipo}`);
                const data = await response.json();
                mostrarPersonasFiltradas(data.success ? data.data : []);
            } catch (error) {
                console.error('Error:', error);
            }
        } else {
            cargarPersonas();
        }
    }

    async function buscarPersonas() {
        const nombre = document.getElementById('searchNombre').value.trim();
        if (nombre.length > 2) {
            try {
                const response = await fetch(`${API_URL}/personas/buscar?nombre=${encodeURIComponent(nombre)}`);
                const data = await response.json();
                mostrarPersonasFiltradas(data.success ? data.data : []);
            } catch (error) {
                console.error('Error:', error);
            }
        } else if (nombre.length === 0) {
            cargarPersonas();
        }
    }

    function mostrarPersonasFiltradas(personas) {
        const tbody = document.getElementById('personasTable');
        if (personas.length > 0) {
            tbody.innerHTML = personas.map(persona => `
                <tr>
                    <td>${persona.dni}</td>
                    <td>${persona.nombreCompleto}</td>
                    <td>${persona.tipoPersona}</td>
                    <td>${persona.telefono || '-'}</td>
                    <td>${persona.correo || '-'}</td>
                    <td>
                        <button onclick="editarPersona('${persona.personaId}')">Editar</button>
                        <button onclick="eliminarPersona('${persona.personaId}')">Eliminar</button>
                        <button onclick="verCertificaciones('${persona.personaId}')">Certificaciones</button>
                        <button onclick="verSalud('${persona.personaId}')">Salud</button>
                        <button onclick="verScores('${persona.personaId}')">Scores</button>
                    </td>
                </tr>
            `).join('');
        } else {
            tbody.innerHTML = '<tr><td colspan="6">No se encontraron personas</td></tr>';
        }
    }
</script>
</body>
</html>